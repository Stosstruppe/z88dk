1     0000              ; ANSIで保存
2     0000              
3     0000              	org	$d000
4     0000              
5     0000  00 00 01 00 04 00 09 00 10 00 19 00 24 00 31 00 
                        powtbl:	dw	0, 1, 4, 9, 16, 25, 36, 49
6     0010  40 00 51 00 64 00 79 00 90 00 A9 00 C4 00 E1 00 
                        	dw	64, 81, 100, 121, 144, 169, 196, 225
7     0020  00 01 21 01 44 01 69 01 90 01 B9 01 E4 01 11 02 
                        	dw	256, 289, 324, 361, 400, 441, 484, 529
8     0030  40 02 71 02 A4 02 D9 02 10 03 49 03 84 03 C1 03 
                        	dw	576, 625, 676, 729, 784, 841, 900, 961
9     0040  00 04 41 04 84 04 C9 04 10 05 59 05 A4 05 F1 05 
                        	dw	1024, 1089, 1156, 1225, 1296, 1369, 1444, 1521
10    0050  40 06 91 06 E4 06 39 07 90 07 E9 07 44 08 A1 08 
                        	dw	1600, 1681, 1764, 1849, 1936, 2025, 2116, 2209
11    0060  00 09 61 09 C4 09 29 0A 90 0A F9 0A 64 0B D1 0B 
                        	dw	2304, 2401, 2500, 2601, 2704, 2809, 2916, 3025
12    0070  40 0C B1 0C 24 0D 99 0D 10 0E 89 0E 04 0F 81 0F 
                        	dw	3136, 3249, 3364, 3481, 3600, 3721, 3844, 3969
13    0080  00 10 81 10 04 11 89 11 10 12 99 12 24 13 B1 13 
                        	dw	4096, 4225, 4356, 4489, 4624, 4761, 4900, 5041
14    0090  40 14 D1 14 64 15 F9 15 90 16 29 17 C4 17 61 18 
                        	dw	5184, 5329, 5476, 5625, 5776, 5929, 6084, 6241
15    00A0  00 19 A1 19 44 1A E9 1A 90 1B 39 1C E4 1C 91 1D 
                        	dw	6400, 6561, 6724, 6889, 7056, 7225, 7396, 7569
16    00B0  40 1E F1 1E A4 1F 59 20 10 21 C9 21 84 22 41 23 
                        	dw	7744, 7921, 8100, 8281, 8464, 8649, 8836, 9025
17    00C0  00 24 C1 24 84 25 49 26 10 27 D9 27 A4 28 71 29 
                        	dw	9216, 9409, 9604, 9801, 10000, 10201, 10404, 10609
18    00D0  40 2A 11 2B E4 2B B9 2C 90 2D 69 2E 44 2F 21 30 
                        	dw	10816, 11025, 11236, 11449, 11664, 11881, 12100, 12321
19    00E0  00 31 E1 31 C4 32 A9 33 90 34 79 35 64 36 51 37 
                        	dw	12544, 12769, 12996, 13225, 13456, 13689, 13924, 14161
20    00F0  40 38 31 39 24 3A 19 3B 10 3C 09 3D 04 3E 01 3F 
                        	dw	14400, 14641, 14884, 15129, 15376, 15625, 15876, 16129
21    0100  00 40 01 41 04 42 09 43 10 44 19 45 24 46 31 47 
                        	dw	16384, 16641, 16900, 17161, 17424, 17689, 17956, 18225
22    0110  40 48 51 49 64 4A 79 4B 90 4C A9 4D C4 4E E1 4F 
                        	dw	18496, 18769, 19044, 19321, 19600, 19881, 20164, 20449
23    0120  00 51 21 52 44 53 69 54 90 55 B9 56 E4 57 11 59 
                        	dw	20736, 21025, 21316, 21609, 21904, 22201, 22500, 22801
24    0130  40 5A 71 5B A4 5C D9 5D 10 5F 49 60 84 61 C1 62 
                        	dw	23104, 23409, 23716, 24025, 24336, 24649, 24964, 25281
25    0140  00 64 41 65 84 66 C9 67 10 69 59 6A A4 6B F1 6C 
                        	dw	25600, 25921, 26244, 26569, 26896, 27225, 27556, 27889
26    0150  40 6E 91 6F E4 70 39 72 90 73 E9 74 44 76 A1 77 
                        	dw	28224, 28561, 28900, 29241, 29584, 29929, 30276, 30625
27    0160  00 79 61 7A C4 7B 29 7D 90 7E F9 7F 64 81 D1 82 
                        	dw	30976, 31329, 31684, 32041, 32400, 32761, 33124, 33489
28    0170  40 84 B1 85 24 87 99 88 10 8A 89 8B 04 8D 81 8E 
                        	dw	33856, 34225, 34596, 34969, 35344, 35721, 36100, 36481
29    0180  00 90 81 91 04 93 89 94 10 96 99 97 24 99 B1 9A 
                        	dw	36864, 37249, 37636, 38025, 38416, 38809, 39204, 39601
30    0190  40 9C D1 9D 64 9F F9 A0 90 A2 29 A4 C4 A5 61 A7 
                        	dw	40000, 40401, 40804, 41209, 41616, 42025, 42436, 42849
31    01A0  00 A9 A1 AA 44 AC E9 AD 90 AF 39 B1 E4 B2 91 B4 
                        	dw	43264, 43681, 44100, 44521, 44944, 45369, 45796, 46225
32    01B0  40 B6 F1 B7 A4 B9 59 BB 10 BD C9 BE 84 C0 41 C2 
                        	dw	46656, 47089, 47524, 47961, 48400, 48841, 49284, 49729
33    01C0  00 C4 C1 C5 84 C7 49 C9 10 CB D9 CC A4 CE 71 D0 
                        	dw	50176, 50625, 51076, 51529, 51984, 52441, 52900, 53361
34    01D0  40 D2 11 D4 E4 D5 B9 D7 90 D9 69 DB 44 DD 21 DF 
                        	dw	53824, 54289, 54756, 55225, 55696, 56169, 56644, 57121
35    01E0  00 E1 E1 E2 C4 E4 A9 E6 90 E8 79 EA 64 EC 51 EE 
                        	dw	57600, 58081, 58564, 59049, 59536, 60025, 60516, 61009
36    01F0  40 F0 31 F2 24 F4 19 F6 10 F8 09 FA 04 FC 01 FE 
                        	dw	61504, 62001, 62500, 63001, 63504, 64009, 64516, 65025
37    0200              
38    0200  BD BF C0 C1 C3 C4 C5 C7 C8 C9 
                        t64_48:	db	-67,-65,-64,-63,-61,-60,-59,-57,-56,-55
39    020A  CB CC CD CF D0 D1 D3 D4 D5 D7 
                        	db	-53,-52,-51,-49,-48,-47,-45,-44,-43,-41
40    0214  D8 D9 DB DC DD DF E0 E1 E3 E4 
                        	db	-40,-39,-37,-36,-35,-33,-32,-31,-29,-28
41    021E  E5 E7 E8 E9 EB EC ED EF F0 F1 
                        	db	-27,-25,-24,-23,-21,-20,-19,-17,-16,-15
42    0228  F3 F4 F5 F7 F8 F9 FB FC FD FF 
                        	db	-13,-12,-11,-9,-8,-7,-5,-4,-3,-1
43    0232  00 01 03 04 05 07 08 09 0B 0C 
                        	db	0,1,3,4,5,7,8,9,11,12
44    023C  0D 0F 10 11 13 14 15 17 18 19 
                        	db	13,15,16,17,19,20,21,23,24,25
45    0246  1B 1C 1D 1F 20 21 23 24 25 27 
                        	db	27,28,29,31,32,33,35,36,37,39
46    0250  28 29 2B 2C 2D 2F 30 31 33 34 
                        	db	40,41,43,44,45,47,48,49,51,52
47    025A  35 37 38 39 3B 3C 3D 3F 40 41 
                        	db	53,55,56,57,59,60,61,63,64,65
48    0264              
49    0264  00          sx:	ds	1	; screen 0..99
50    0265  00          sy:	ds	1
51    0266  00          px:	ds	1	; pos -64..64
52    0267  00          py:	ds	1
53    0268  00          pz:	ds	1
54    0269  00 00       yy:	ds	2	; y**2
55    026B  00 00       tmp:	ds	2
56    026D  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
      028D  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
      02AD  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
      02CD  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
      02ED  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
                        filler:	ds	256-109
57    0300              
58    0300              		; $d300
59    0300  01 04 12 48 13 4C 33 CC 
                        mask:	db	$01,$04,$12,$48,$13,$4c,$33,$cc
60    0308              
61    0308              		; $d308
62    0308  CD 24 04    	call	init
63    030B              
64    030B  AF          	xor	a
65    030C              Lout:
66    030C  32 65 02    	ld	(sy), a
67    030F  CD 78 03    	call	s2p
68    0312  32 67 02    	ld	(py), a
69    0315  CD 7D 03    	call	pow
70    0318  ED 53 69 02 	ld	(yy), de
71    031C  AF          	xor	a
72    031D              Lin:
73    031D  32 64 02    	ld	(sx), a
74    0320  CD 3B 03    	call	calc
75    0323              
76    0323  3A 64 02    	ld	a, (sx)
77    0326  C6 02       	add	a, 2
78    0328  FE 64       	cp	100
79    032A  DA 1D 03    	jp	c, Lin
80    032D              
81    032D  3A 65 02    	ld	a, (sy)
82    0330  C6 02       	add	a, 2
83    0332  FE 64       	cp	100
84    0334  DA 0C 03    	jp	c, Lout
85    0337              L9:
86    0337  76          	halt
87    0338  C3 37 03    	jp	L9
88    033B              
89    033B              ; a: sx
90    033B              calc:
91    033B  CD 78 03    	call	s2p
92    033E  32 66 02    	ld	(px), a
93    0341  CD 7D 03    	call	pow		; de = x**2
94    0344  2A 69 02    	ld	hl, (yy)
95    0347  19          	add	hl, de
96    0348  EB          	ex	de, hl
97    0349  21 00 10    	ld	hl, 64*64
98    034C  ED 52       	sbc	hl, de		; zz = sqrt(rr - (xx + yy))
99    034E  D8          	ret	c
100   034F              
101   034F  7D          	ld	a, l
102   0350  6C          	ld	l, h
103   0351  CD 8B 03    	call	sqrt
104   0354  7A          	ld	a, d		; z = sqrt(zz)
105   0355  32 68 02    	ld	(pz), a
106   0358              
107   0358  CD A8 03    	call	dot
108   035B  B7          	or	a
109   035C  F2 60 03    	jp	p, calc1
110   035F  AF          	xor	a
111   0360              calc1:
112   0360  1F          	rra
113   0361  1F          	rra
114   0362  1F          	rra
115   0363  1F          	rra
116   0364  E6 03       	and	$03
117   0366              
118   0366  ED 4B 64 02 	ld	bc, (sx)
119   036A  6F          	ld	l, a
120   036B  79          	ld	a, c
121   036C  C6 1E       	add	a, 30
122   036E  4F          	ld	c, a
123   036F  7D          	ld	a, l
124   0370  CB 39       	srl	c
125   0372  CB 38       	srl	b
126   0374  CD FF 03    	call	qpset
127   0377  C9          	ret
128   0378              
129   0378              ; screen to pos
130   0378              ; a = s2p(a)
131   0378              s2p:
132   0378  6F          	ld	l, a
133   0379  26 02       	ld	h, t64_48/256
134   037B  7E          	ld	a, (hl)
135   037C  C9          	ret
136   037D              
137   037D              ; hl = pow(a, 2)
138   037D              pow:
139   037D  B7          	or	a
140   037E  F2 83 03    	jp	p, pow1
141   0381  ED 44       	neg
142   0383              pow1:
143   0383  6F          	ld	l, a
144   0384  26 00       	ld	h, powtbl/512
145   0386  29          	add	hl, hl
146   0387  5E          	ld	e, (hl)
147   0388  2C          	inc	l
148   0389  56          	ld	d, (hl)
149   038A  C9          	ret
150   038B              
151   038B              ; d = sqrt(la)
152   038B              sqrt:
153   038B  11 40 00    	ld	de, 0040h
154   038E  62          	ld	h, d
155   038F  06 07       	ld	b, 7
156   0391  B7          	or	a
157   0392              sqrt1:
158   0392  ED 52       	sbc	hl, de
159   0394  30 01       	jr	nc, sqrt2
160   0396  19          	add	hl, de
161   0397              sqrt2:
162   0397  3F          	ccf
163   0398  CB 12       	rl	d
164   039A  17          	rla
165   039B  ED 6A       	adc	hl, hl
166   039D  17          	rla
167   039E  ED 6A       	adc	hl, hl
168   03A0  10 F0       	djnz	sqrt1
169   03A2  ED 52       	sbc	hl, de
170   03A4  3F          	ccf
171   03A5  CB 12       	rl	d
172   03A7  C9          	ret
173   03A8              
174   03A8              dot:
175   03A8  3A 66 02    	ld	a, (px)
176   03AB  2E 2B       	ld	l, 43
177   03AD  CD CF 03    	call	mul8s
178   03B0  7C          	ld	a, h
179   03B1  32 6B 02    	ld	(tmp), a
180   03B4  3A 67 02    	ld	a, (py)
181   03B7  2E EB       	ld	l, -21
182   03B9  CD CF 03    	call	mul8s
183   03BC  7C          	ld	a, h
184   03BD  32 6C 02    	ld	(tmp+1), a
185   03C0  3A 68 02    	ld	a, (pz)
186   03C3  2E 2B       	ld	l, 43
187   03C5  CD CF 03    	call	mul8s
188   03C8  7C          	ld	a, h
189   03C9  2A 6B 02    	ld	hl, (tmp)
190   03CC  84          	add	a, h
191   03CD  85          	add	a, l
192   03CE  C9          	ret
193   03CF              
194   03CF              ; hl = a * l
195   03CF              mul8s:
196   03CF  5F          	ld	e, a
197   03D0  16 80       	ld	d, 80h
198   03D2              ;	ld	a, e
199   03D2  AA          	xor	d
200   03D3  5F          	ld	e, a
201   03D4              				; 1st
202   03D4  CB 3D       	srl	l
203   03D6  38 01       	jr	c, mul1
204   03D8  7A          	ld	a, d
205   03D9              mul1:
206   03D9  CB 3F       	srl	a
207   03DB  CB 1D       	rr	l
208   03DD              				; 2-7
209   03DD  06 06       	ld	b, 6
210   03DF              mul2:
211   03DF  30 04       	jr	nc, mul3
212   03E1  83          	add	a, e
213   03E2  C3 E6 03    	jp	mul4
214   03E5              mul3:
215   03E5  82          	add	a, d
216   03E6              mul4:
217   03E6  1F          	rra
218   03E7  CB 1D       	rr	l
219   03E9  10 F4       	djnz	mul2
220   03EB              				; final
221   03EB  30 07       	jr	nc, mul5
222   03ED  67          	ld	h, a
223   03EE  7B          	ld	a, e
224   03EF  2F          	cpl
225   03F0  84          	add	a, h
226   03F1  C3 F6 03    	jp	mul6
227   03F4              mul5:
228   03F4  C6 7F       	add	a, 7fh
229   03F6              mul6:
230   03F6  1F          	rra
231   03F7  CB 1D       	rr	l
232   03F9  C6 81       	add	a, 81h
233   03FB  67          	ld	h, a
234   03FC              				; hl <<= 2
235   03FC  29          	add	hl, hl
236   03FD  29          	add	hl, hl
237   03FE  C9          	ret
238   03FF              
239   03FF              ; b: y 0-49 yh=y/2 yl=y%2
240   03FF              ; c: x 0-79
241   03FF              ; l: dot 0-3
242   03FF              qpset:
243   03FF  79          	ld	a, c
244   0400  FE 50       	cp	80
245   0402  D0          	ret	nc		; if (x >= 80) return
246   0403  78          	ld	a, b
247   0404  FE 32       	cp	50
248   0406  D0          	ret	nc		; if (y >= 50) return
249   0407  E5          	push	hl
250   0408              
251   0408  78          	ld	a, b
252   0409  E6 3E       	and	$3e		; a = yh*2
253   040B  C6 75       	add	a, $75
254   040D  6F          	ld	l, a
255   040E  26 06       	ld	h, $06		; hl = $0675 + a
256   0410  5E          	ld	e, (hl)
257   0411  2C          	inc	l
258   0412  56          	ld	d, (hl)		; de = $f300 + 120*yh
259   0413  69          	ld	l, c
260   0414  26 00       	ld	h, 0
261   0416  19          	add	hl, de
262   0417  EB          	ex	de, hl		; de += x
263   0418              
264   0418  E1          	pop	hl
265   0419  CB 38       	srl	b
266   041B  CB 15       	rl	l		; %ddy
267   041D  26 03       	ld	h, mask/256
268   041F  7E          	ld	a, (hl)
269   0420  EB          	ex	de, hl
270   0421  B6          	or	(hl)
271   0422  77          	ld	(hl), a
272   0423  C9          	ret
273   0424              
274   0424              init:
275   0424  01 00 00    	ld	bc, $0000
276   0427  CD F7 08    	call	$08f7		; function / color
277   042A  21 37 04    	ld	hl, color
278   042D  CD 51 09    	call	$0951		; color
279   0430  01 19 50    	ld	bc, 80*256+25
280   0433  CD 3A 09    	call	$093a		; width
281   0436  C9          	ret
282   0437  30 2C 30 2C 31 00 
                        color:	db	"0,0,1", 0	; 低解像度グラフィック
283   043D              
